# 代码审查与 PR 自检（仅审查版）

【输入】
- scope：审查范围（与 `review_target` 二选一；留空=当前分支改动）。
- review_target：commit range/目录/文件（可留空）。
- report_path：报告路径（默认 `.conversations/reports/code-review-report.md`）。
- acceptance_criteria：至少给出 P0/P1/P2 问题、证据、修复建议、验证方式、优先级路线图。
- constraints：审查深度、时间预算、不可触碰目录、是否允许运行命令。
- focus：重点方向（性能/测试/边界/错误处理/并发时序/可观测性/前端交互等）。

【需要完成的功能】
- 仅做代码审查（不改代码），输出可执行的整改方案与合并结论。

【注意事项】
- 通用审查基线（必须）：先扫描事实→再分级问题→最后给路线图；最多追问 3 个阻塞问题；每条 `acceptance_criteria` 必须有证据；至少覆盖 3 个高风险边界；按【输出】原样输出。
- 默认从仓库推断技术栈、命令和约定，不要向用户反问“框架/启动命令”。
- 两遍审查：第 1 遍理解意图/数据流/调用链；第 2 遍逐条检查边界、异常、并发、资源释放、状态一致性、时间时区、编码格式。
- 优先看测试再看实现；无测试时明确“最小回归建议”。
- 对 PR 里的“已覆盖/无影响”等断言必须核验；无法确认的标记为“风险点/待验证”。
- 能跑就跑（lint/test/build/typecheck/smoke）并留痕；不能跑写阻塞原因与可信度影响。
- 报告必须落盘到 `report_path`，并在结尾回写路径与摘要。

【输出】
- 扫描结论（审查范围、项目事实、可用命令、相似约定）。
- 问题清单（P0/P1/P2，字段：位置/触发条件/影响/证据/修复建议/验证方式）。
- 整改优先级路线图（P0→P1→P2，含收益/风险/工作量）。
- 验证清单（已执行命令 + 结果摘要；未执行项的手工验证步骤）。
- 审查报告（已保存路径 + 报告摘要）。
- PR 自检结论（可合并/需修复后复审/阻塞项）。
- 验收映射表（acceptance_criteria → 问题分级/证据/修复建议）。
- 机器可读摘要（JSON）：{"status":"success|partial|blocked","scope":[],"findings":[],"evidence":[],"priority_plan":[],"next_actions":[]}。
