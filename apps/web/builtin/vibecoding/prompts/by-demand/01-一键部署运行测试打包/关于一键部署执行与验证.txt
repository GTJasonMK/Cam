# 一键部署执行与验证（执行版）

【输入】
- scope：部署范围（默认全仓库；可留空为指定服务/模块）。
- acceptance_criteria：明确部署成功标准（服务可访问、关键健康检查通过、最小业务路径可用、失败可回滚）。
- constraints：
  - 不允许硬编码端口；优先读取 env/参数，缺省时自动探测空闲端口并输出最终端口。
  - Python 项目必须使用 `uv` 管理环境与依赖（`.venv` + `uv run`）。
  - Windows 脚本必须兼容中文路径，`.bat` 场景按 CRLF 与返回码规范执行。
  - 禁止静默下载未知工具；缺工具必须给安装指引并退出。
- （可留空）deploy_target：本地/测试机/容器。
- （可留空）deploy_entry：已有部署命令或脚本入口。
- （可留空）upstream_handoff_path：上一步交接文件路径。
- （可留空）handoff_output_dir：默认 `.conversations/pipeline-handoffs/<pipeline_id>/`。

【需要完成的功能】
- 为当前仓库落地“一键部署”能力：从依赖准备到部署启动再到可验证可回滚。

【注意事项】
- 通用执行基线（必须）：仅执行落地（不做全面审查/分析）；先确认目标与验收（≤3 行）→扫描仓库事实→3-7 步执行（每步含影响面/验证/回滚）→回填证据；最多追问 3 个阻塞问题；每条 `acceptance_criteria` 必须映射证据；至少 1 条失败路径验证；非本轮问题写入“风险补充”；按【输出】原样输出。
- 如提供 `upstream_handoff_path`，必须先读取并对齐上一步约束与未完成项。
- 默认从仓库推断部署相关入口（脚本、Docker/Compose、服务启动命令、环境变量），不要反问可自动扫描的信息。
- 优先复用现有工具链，不无故替换包管理器或构建体系。
- 失败回滚必须可执行：至少包含停止服务、恢复配置或恢复上一可用版本步骤。
- 能跑就跑部署与健康检查命令并留痕；不能跑写阻塞原因与最小手工验证方案。
- 如提供 `handoff_output_dir`，结束时必须写 `step-summary.md` 与 `step-handoff.json`。

【输出】
- 输入确认结果（范围、验收口径、约束）。
- 扫描结论（部署入口、依赖、环境变量、端口策略、可用命令）。
- 执行计划（3-7 步，每步含影响面/验证/回滚点）。
- 变更清单（按文件：改动内容/原因）。
- 验证命令与结果摘要（部署命令、健康检查、关键路径验证）。
- 风险补充（未完成项/原因/下一步）。
- 回滚清单（故障时的可执行恢复步骤）。
- 流水线交接文件（若提供 `handoff_output_dir`：`step-summary.md` + `step-handoff.json`）。
- 验收映射表（acceptance_criteria → 改动点 → 验证证据）。
- 机器可读摘要（JSON）：{"status":"success|partial|blocked","scope":[],"changed_files":[],"verification":[],"unresolved":[],"next_actions":[]}。
